name: Deploy iOS to App Store

on:
  release:
    types:
      [released, prereleased]

jobs:
  build-ios:
    runs-on: ${{ matrix.os }}
    if: |
      startsWith(github.ref, 'refs/tags/@quiet/mobile')

    strategy:
      matrix:
        os: [macOS-latest]

    steps:
      - name: "Print OS"
        run: echo ${{ matrix.os }}

      - uses: actions/checkout@v2

      - name: Install gpg
        run: brew install gnupg

      - name: Setup XCode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '14.2'

      - name: Setup environment
        uses: ./.github/actions/setup-env
        with:
          bootstrap-packages: "@quiet/logger,@quiet/state-manager,@quiet/backend,@quiet/identity,@quiet/mobile,backend-bundle,create-require-loader"

      - name: Install pod dependencies
        run: |
          cd ./packages/mobile/ios
          pod install
        shell: bash

      - name: Setup provisioning profile
        run: ./.github/secrets/decrypt_secrets.sh
        env:
          IOS_PROFILE_KEY: ${{ secrets.IOS_PROFILE_KEY }}
          IOS_CERTIFICATE_KEY: ${{ secrets.IOS_CERTIFICATE_KEY }}

      - name: Build
        run: |
          cd ./packages/mobile/ios
          xcodebuild archive \
            -workspace Quiet.xcworkspace \
            -scheme Quiet \
            -configuration Release \
            -archivePath $PWD/build/Quiet.xcarchive \
            PROVISIONING_PROFILE="654a2214-095f-4939-a9e5-09f7a2ccf530" \
            CODE_SIGN_IDENTITY="Apple Distribution: Zbay LLC (CTYKSWN9T4)"

      - name: Export
        run: |
          cd ./packages/mobile/ios
          xcodebuild \
            -exportArchive \
            -archivePath $PWD/build/Quiet.xcarchive \
            -exportOptionsPlist $PWD/ci.plist \
            -exportPath $PWD/build

      - name: Compress
        run: |
          cd ./packages/mobile/ios
          ditto -c -k --keepParent $PWD/build/Quiet.xcarchive $PWD/build/Quiet.zip

      - name: Upload
        run: |
          cd ./packages/mobile/ios
          xcrun notarytool submit $PWD/build/Quiet.zip \
            --team-id CTYKSWN9T4 \
            --apple-id $APPSTORE_USER \
            --password $APPSTORE_PASSWORD \
            --no-wait \
            --verbose
        env:
          APPSTORE_USER: ${{ secrets.APPSTORE_USER }}
          APPSTORE_PASSWORD: ${{ secrets.APPSTORE_PASSWORD }}
